# Environment variables for Worker
# Copy this file to .env and update the values

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================

DATABASE_URL=postgresql://postgres:postgres@localhost:5432/supercheck

# Connection Pool Settings (postgres-js)
# See: https://github.com/porsager/postgres#connection-pool
DB_POOL_MAX=10                 # Maximum number of connections (default: 10)
DB_IDLE_TIMEOUT=30             # Seconds before idle connections are closed (default: 30)
DB_CONNECT_TIMEOUT=10          # Seconds to wait for connection (default: 10)
DB_MAX_LIFETIME=1800           # Seconds before connections are recycled (default: 1800 = 30 min)

# =============================================================================
# AWS S3 / MINIO CONFIGURATION
# =============================================================================

AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=minioadmin
AWS_SECRET_ACCESS_KEY=minioadmin
S3_ENDPOINT=http://localhost:9000
S3_JOB_BUCKET_NAME=playwright-job-artifacts
S3_TEST_BUCKET_NAME=playwright-test-artifacts
S3_MONITOR_BUCKET_NAME=playwright-monitor-artifacts
S3_K6_TEST_BUCKET_NAME=k6-test-artifacts
S3_K6_JOB_BUCKET_NAME=k6-job-artifacts
S3_STATUS_BUCKET_NAME=status-page-artifacts
S3_FORCE_PATH_STYLE=true
S3_OPERATION_TIMEOUT=10000
S3_MAX_RETRIES=3

# =============================================================================
# K6 PERFORMANCE TESTING CONFIGURATION
# =============================================================================

# k6 Binary Path (OPTIONAL - auto-detected if k6 is in PATH)
# The worker automatically detects k6 based on environment:
#   - Local Dev: Uses 'k6' from PATH (install with: brew install k6)
#   - Production/Docker: Uses '/usr/local/bin/k6' (installed in Dockerfile)
#   - Custom: Uncomment and set K6_BIN_PATH to specify a custom location
# K6_BIN_PATH=/usr/local/bin/k6

# Maximum concurrent k6 test executions
# k6 tests are CPU and network intensive, so limit concurrent runs
# Recommended values:
#   - Small VM (2 CPU): 1
#   - Medium VM (4 CPU): 1
#   - Large VM (8+ CPU): 2-3
K6_MAX_CONCURRENCY=1
K6_TEST_EXECUTION_TIMEOUT_MS=3600000      # 60 minutes max per single test
K6_JOB_EXECUTION_TIMEOUT_MS=3600000       # 60 minutes max per aggregated job

# Worker Location (for geo-distributed monitoring and load testing)
# Determines which geographical region this worker represents
# Options: us-east | eu-central | asia-pacific | local
#
# Local Development:
#   - Set to 'local' to process ALL regional queues (monitor-us-east, monitor-eu-central, monitor-asia-pacific)
#   - Single worker handles all regions sequentially
#
# Production Multi-Region Setup:
#   - Deploy separate worker instances per region with different WORKER_LOCATION values:
#     - AWS US-East worker: WORKER_LOCATION=us-east (processes monitor-us-east queue)
#     - AWS EU-Central worker: WORKER_LOCATION=eu-central (processes monitor-eu-central queue)
#     - AWS Asia-Pacific worker: WORKER_LOCATION=asia-pacific (processes monitor-asia-pacific queue)
WORKER_LOCATION=local

# Location Filtering (for multi-region deployments)
# When false (MVP mode):
#   - Single worker processes all k6 jobs regardless of location
#   - Location is stored in database but not enforced
#   - Good for: Local dev, single-region deployments
# When true (Production mode):
#   - Worker only processes jobs matching its WORKER_LOCATION
#   - Enables true geo-distributed load testing
#   - Good for: Multi-region production deployments
# Set to false for local development, true for multi-region production
ENABLE_LOCATION_FILTERING=false

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

# App URL (used for notification links and callbacks)
APP_URL=http://localhost:3000
TEST_EXECUTION_TIMEOUT_MS=120000
JOB_EXECUTION_TIMEOUT_MS=900000
RUNNING_CAPACITY=1  # Default: 1 worker × 1 concurrent run (keep in sync with WORKER_REPLICAS)
QUEUED_CAPACITY=10  # Queue size for single worker
# Note: MAX_CONCURRENT_EXECUTIONS is hardcoded to 1 in worker code. Scale via WORKER_REPLICAS instead.
# Container limits for 2 vCPU / 4GB servers
CONTAINER_CPU_LIMIT=1.5
CONTAINER_MEMORY_LIMIT_MB=2048

# Environment and Logging
# NODE_ENV controls NestJS logging verbosity:
# - development: Shows all logs including DEBUG and VERBOSE
# - production: Only ERROR, WARN, and LOG levels (no DEBUG logs)
NODE_ENV=development

# =============================================================================
# DATA LIFECYCLE MANAGEMENT (CLEANUP) CONFIGURATION
# =============================================================================
# Note: Retention periods are configured per plan in the database (plan_limits table)
# The cleanup jobs use plan settings, not environment variables for retention days.

# Monitor Results Cleanup (retention per plan from database)
MONITOR_CLEANUP_ENABLED=true
MONITOR_CLEANUP_CRON="0 2 * * *"                  # 2 AM daily
MONITOR_CLEANUP_BATCH_SIZE=1000                    # Batch size for deletions
MONITOR_PRESERVE_STATUS_CHANGES=true               # Keep status change events
MONITOR_CLEANUP_SAFETY_LIMIT=1000000               # Max records per cleanup run

# Monitor Aggregates Cleanup (retention per plan from database)
MONITOR_AGGREGATES_CLEANUP_ENABLED=true
MONITOR_AGGREGATES_CLEANUP_CRON="30 2 * * *"      # 2:30 AM daily
MONITOR_AGGREGATES_CLEANUP_BATCH_SIZE=1000         # Batch size for deletions
MONITOR_AGGREGATES_CLEANUP_SAFETY_LIMIT=500000     # Max records per cleanup run

# Job Runs Cleanup (retention per plan from database)
JOB_RUNS_CLEANUP_ENABLED=true                      # Enabled by default for storage management
JOB_RUNS_CLEANUP_CRON="0 3 * * *"                 # 3 AM daily
JOB_RUNS_CLEANUP_BATCH_SIZE=100                    # Smaller batches for complex operations
JOB_RUNS_CLEANUP_SAFETY_LIMIT=10000                # Max records per cleanup run

# Playground Artifacts Cleanup
PLAYGROUND_CLEANUP_ENABLED=true
PLAYGROUND_CLEANUP_CRON="0 5 * * *"               # 5 AM daily
PLAYGROUND_CLEANUP_MAX_AGE_HOURS=24               # Delete after 24 hours

# Webhook Idempotency Cleanup (TTL-based deduplication records)
WEBHOOK_CLEANUP_ENABLED=true
WEBHOOK_CLEANUP_CRON="0 4 * * *"                  # 4 AM daily
WEBHOOK_CLEANUP_BATCH_SIZE=1000                    # Batch size for deletions
WEBHOOK_CLEANUP_SAFETY_LIMIT=100000                # Max records per cleanup run

# =============================================================================
# REDIS CONFIGURATION
# =============================================================================

REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=supersecure-redis-password-change-this
REDIS_URL=redis://:supersecure-redis-password-change-this@localhost:6379
# Enable TLS for cloud Redis (Upstash, Redis Cloud, etc.) - set to 'true' in production
REDIS_TLS_ENABLED=false

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# Better Auth Secret - REQUIRED for production (generate with: openssl rand -hex 32)
BETTER_AUTH_SECRET=your-super-secret-key-change-this-in-production
BETTER_AUTH_URL=http://localhost:3000

# Encryption Keys - REQUIRED for production
# Generate with: openssl rand -hex 32
VARIABLES_ENCRYPTION_KEY=your-64-character-encryption-key-for-variable-secrets-change-this-in-prod
CREDENTIAL_ENCRYPTION_KEY=your-credential-encryption-key-change-this-in-production

# =============================================================================
# ADMIN CONFIGURATION
# =============================================================================

MAX_PROJECTS_PER_ORG=10
DEFAULT_PROJECT_NAME="Default Project"

# =============================================================================
# EMAIL CONFIGURATION FOR NOTIFICATIONS
# =============================================================================

# SMTP Configuration - Can use any SMTP provider including Resend's SMTP
# Examples:
# - Gmail: smtp.gmail.com (use App Password with 2FA enabled)
# - Resend SMTP: smtp.resend.com (use API key as password)
# - SendGrid: smtp.sendgrid.net
# - Amazon SES: email-smtp.region.amazonaws.com

SMTP_HOST=smtp.resend.com
SMTP_PORT=587
SMTP_USER=resend
SMTP_PASSWORD=your-smtp-password-change-this-in-production
SMTP_SECURE=false
SMTP_FROM_EMAIL=notification@supercheck.io

# =============================================================================
# PLAYWRIGHT CONFIGURATION
# =============================================================================

# Playwright Artifact Configuration
# Control which artifacts are collected and retained during test execution.
# Available options (for trace & video, and for screenshot in newer versions):
#   'on'                 - Always collect (for every test run)
#   'off'                - Never collect
#   'only-on-failure'    - Collect only when the test fails (original or retry)
#   'retain-on-failure'  - Collect always, but delete if test passes
#   'on-first-retry'     - Collect only when retrying a failed test (for trace & video)
#   [trace-only] 'retain-on-first-failure' — valid for trace as of certain versions :contentReference[oaicite:0]{index=0}

PLAYWRIGHT_HEADLESS=true             # Run browsers in headless mode for non-interactive test runs
PLAYWRIGHT_WORKERS=1                 # Single worker for 2GB container memory
PLAYWRIGHT_RETRIES=1                 # Retry each failing test once before final failure

PLAYWRIGHT_TRACE=retain-on-failure      # Keep trace only if the test fails
PLAYWRIGHT_SCREENSHOT=only-on-failure   # Take screenshots only on failures
PLAYWRIGHT_VIDEO=retain-on-failure      # Record video and remove if the test passes

# For maximum debugging you could use 'only-on-failure' for all,
# but that may consume more storage in CI if many tests fail.


# Polar Configuration
POLAR_ACCESS_TOKEN=your-polar-access-token
POLAR_WEBHOOK_SECRET=your-polar-webhook-secret

