{{- $secretName := include "supercheck.secretName" . -}}
{{- $dbHost := ternary (include "supercheck.postgres.fullname" .) .Values.config.database.host (and .Values.postgres.enabled (not .Values.config.database.host)) -}}
{{- if not $dbHost }}
{{- fail "config.database.host must be set when postgres.enabled is false" }}
{{- end }}
{{- $dbPort := default 5432 .Values.config.database.port -}}
{{- $redisHost := ternary (include "supercheck.redis.fullname" .) .Values.config.redis.host (and .Values.redis.enabled (not .Values.config.redis.host)) -}}
{{- if not $redisHost }}
{{- fail "config.redis.host must be set when redis.enabled is false" }}
{{- end }}
{{- $redisPort := default 6379 .Values.config.redis.port -}}
{{- if .Values.secrets.create }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "supercheck.labels" . | nindent 4 }}
    {{- include "supercheck.componentLabels" "secrets" | nindent 4 }}
type: Opaque
stringData:
  DB_PASSWORD: {{ .Values.secrets.databasePassword | quote }}
  DATABASE_URL: {{ printf "postgresql://%s:%s@%s:%d/%s" .Values.config.database.user .Values.secrets.databasePassword $dbHost (int $dbPort) .Values.config.database.name | quote }}

  REDIS_PASSWORD: {{ .Values.secrets.redisPassword | quote }}
  REDIS_URL: {{ printf "redis://:%s@%s:%d" .Values.secrets.redisPassword $redisHost (int $redisPort) | quote }}

  AWS_ACCESS_KEY_ID: {{ .Values.secrets.s3AccessKey | quote }}
  AWS_SECRET_ACCESS_KEY: {{ .Values.secrets.s3SecretKey | quote }}

  MINIO_ROOT_USER: {{ .Values.secrets.s3AccessKey | quote }}
  MINIO_ROOT_PASSWORD: {{ .Values.secrets.s3SecretKey | quote }}

  BETTER_AUTH_SECRET: {{ .Values.secrets.betterAuthSecret | quote }}
  VARIABLES_ENCRYPTION_KEY: {{ .Values.secrets.variablesEncryptionKey | quote }}
  CREDENTIAL_ENCRYPTION_KEY: {{ .Values.secrets.credentialEncryptionKey | quote }}

  SMTP_PASSWORD: {{ .Values.secrets.smtpPassword | quote }}
  OPENAI_API_KEY: {{ .Values.secrets.openaiApiKey | quote }}

  {{- with .Values.secrets.extra }}
  {{- toYaml . | nindent 2 }}
  {{- end }}
{{- end }}
