{{- $dbHost := ternary (include "supercheck.postgres.fullname" .) .Values.config.database.host (and .Values.postgres.enabled (not .Values.config.database.host)) -}}
{{- if not $dbHost }}
{{- fail "config.database.host must be set when postgres.enabled is false" }}
{{- end }}
{{- $dbPort := default 5432 .Values.config.database.port -}}
{{- $redisHost := ternary (include "supercheck.redis.fullname" .) .Values.config.redis.host (and .Values.redis.enabled (not .Values.config.redis.host)) -}}
{{- if not $redisHost }}
{{- fail "config.redis.host must be set when redis.enabled is false" }}
{{- end }}
{{- $redisPort := default 6379 .Values.config.redis.port -}}
{{- $betterAuthUrl := default .Values.global.appUrl .Values.config.auth.betterAuthUrl -}}
{{- $s3EndpointDefault := printf "http://%s:%d" (include "supercheck.minio.fullname" .) (.Values.minio.service.apiPort | int) -}}
{{- $s3Endpoint := ternary $s3EndpointDefault .Values.config.s3.endpoint (and .Values.minio.enabled (not .Values.config.s3.endpoint)) -}}
{{- if not $s3Endpoint }}
{{- fail "config.s3.endpoint must be set when minio.enabled is false" }}
{{- end }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "supercheck.fullname" . }}-config
  labels:
    {{- include "supercheck.labels" . | nindent 4 }}
    {{- include "supercheck.componentLabels" "config" | nindent 4 }}
data:
  NODE_ENV: {{ .Values.global.nodeEnv | quote }}
  LOG_LEVEL: {{ .Values.global.logLevel | quote }}
  NEXT_PUBLIC_APP_URL: {{ .Values.global.appUrl | quote }}
  APP_URL: {{ .Values.global.appUrl | quote }}
  BETTER_AUTH_URL: {{ $betterAuthUrl | quote }}
  STATUS_PAGE_DOMAIN: {{ .Values.global.statusPageDomain | quote }}
  NEXT_PUBLIC_DEMO_MODE: {{ ternary "true" "false" .Values.global.demoMode | quote }}

  DB_HOST: {{ $dbHost | quote }}
  DB_PORT: {{ $dbPort | quote }}
  DB_NAME: {{ .Values.config.database.name | quote }}
  DB_USER: {{ .Values.config.database.user | quote }}

  REDIS_HOST: {{ $redisHost | quote }}
  REDIS_PORT: {{ $redisPort | quote }}

  AWS_REGION: {{ .Values.config.s3.region | quote }}
  S3_ENDPOINT: {{ $s3Endpoint | quote }}
  S3_FORCE_PATH_STYLE: {{ ternary "true" "false" .Values.config.s3.forcePathStyle | quote }}
  S3_OPERATION_TIMEOUT: {{ .Values.config.s3.operationTimeout | quote }}
  S3_MAX_RETRIES: {{ .Values.config.s3.maxRetries | quote }}
  S3_JOB_BUCKET_NAME: {{ .Values.config.s3.bucketNames.job | quote }}
  S3_TEST_BUCKET_NAME: {{ .Values.config.s3.bucketNames.test | quote }}
  S3_MONITOR_BUCKET_NAME: {{ .Values.config.s3.bucketNames.monitor | quote }}
  S3_STATUS_BUCKET_NAME: {{ .Values.config.s3.bucketNames.status | quote }}
  S3_K6_PERFORMANCE_BUCKET_NAME: {{ .Values.config.s3.bucketNames.performance | quote }}
  S3_PERFORMANCE_BUCKET_NAME: {{ .Values.config.s3.bucketNames.performance | quote }}

  RUNNING_CAPACITY: {{ .Values.config.execution.runningCapacity | quote }}
  QUEUED_CAPACITY: {{ .Values.config.execution.queuedCapacity | quote }}
  MAX_CONCURRENT_EXECUTIONS: {{ .Values.config.execution.maxConcurrentExecutions | quote }}
  TEST_EXECUTION_TIMEOUT_MS: {{ .Values.config.execution.timeouts.test | quote }}
  JOB_EXECUTION_TIMEOUT_MS: {{ .Values.config.execution.timeouts.job | quote }}
  K6_TEST_EXECUTION_TIMEOUT_MS: {{ .Values.config.execution.timeouts.k6Test | quote }}
  K6_JOB_EXECUTION_TIMEOUT_MS: {{ .Values.config.execution.timeouts.k6Job | quote }}

  PLAYWRIGHT_HEADLESS: {{ ternary "true" "false" .Values.config.playwright.headless | quote }}
  PLAYWRIGHT_RETRIES: {{ .Values.config.playwright.retries | quote }}
  PLAYWRIGHT_TRACE: {{ .Values.config.playwright.trace | quote }}
  PLAYWRIGHT_SCREENSHOT: {{ .Values.config.playwright.screenshot | quote }}
  PLAYWRIGHT_VIDEO: {{ .Values.config.playwright.video | quote }}
  ENABLE_FIREFOX: {{ ternary "true" "false" .Values.config.playwright.enableFirefox | quote }}
  ENABLE_WEBKIT: {{ ternary "true" "false" .Values.config.playwright.enableWebkit | quote }}
  ENABLE_MOBILE: {{ ternary "true" "false" .Values.config.playwright.enableMobile | quote }}

  MONITOR_CLEANUP_ENABLED: {{ ternary "true" "false" .Values.config.monitoringCleanup.enabled | quote }}
  MONITOR_CLEANUP_CRON: {{ .Values.config.monitoringCleanup.cron | quote }}
  MONITOR_RETENTION_DAYS: {{ .Values.config.monitoringCleanup.retentionDays | quote }}
  MONITOR_CLEANUP_BATCH_SIZE: {{ .Values.config.monitoringCleanup.batchSize | quote }}
  MONITOR_PRESERVE_STATUS_CHANGES: {{ ternary "true" "false" .Values.config.monitoringCleanup.preserveStatusChanges | quote }}
  MONITOR_CLEANUP_SAFETY_LIMIT: {{ .Values.config.monitoringCleanup.safetyLimit | quote }}

  JOB_RUNS_CLEANUP_ENABLED: {{ ternary "true" "false" .Values.config.jobCleanup.enabled | quote }}
  JOB_RUNS_CLEANUP_CRON: {{ .Values.config.jobCleanup.cron | quote }}
  JOB_RUNS_RETENTION_DAYS: {{ .Values.config.jobCleanup.retentionDays | quote }}
  JOB_RUNS_CLEANUP_BATCH_SIZE: {{ .Values.config.jobCleanup.batchSize | quote }}
  JOB_RUNS_CLEANUP_SAFETY_LIMIT: {{ .Values.config.jobCleanup.safetyLimit | quote }}

  PLAYGROUND_CLEANUP_ENABLED: {{ ternary "true" "false" .Values.config.playgroundCleanup.enabled | quote }}
  PLAYGROUND_CLEANUP_CRON: {{ .Values.config.playgroundCleanup.cron | quote }}
  PLAYGROUND_CLEANUP_MAX_AGE_HOURS: {{ .Values.config.playgroundCleanup.maxAgeHours | quote }}

  NEXT_PUBLIC_MAX_JOB_NOTIFICATION_CHANNELS: {{ .Values.config.notificationLimits.jobs | quote }}
  NEXT_PUBLIC_MAX_MONITOR_NOTIFICATION_CHANNELS: {{ .Values.config.notificationLimits.monitors | quote }}

  MULTI_LOCATION_DISTRIBUTED: {{ ternary "true" "false" .Values.config.featureFlags.multiLocationDistributed | quote }}
  WORKER_LOCATION: {{ .Values.config.featureFlags.workerLocation | quote }}

  SMTP_HOST: {{ .Values.config.smtp.host | quote }}
  SMTP_PORT: {{ .Values.config.smtp.port | quote }}
  SMTP_USER: {{ .Values.config.smtp.user | quote }}
  SMTP_SECURE: {{ ternary "true" "false" .Values.config.smtp.secure | quote }}
  SMTP_FROM_EMAIL: {{ .Values.config.smtp.fromEmail | quote }}

  AI_PROVIDER: {{ .Values.config.ai.provider | quote }}
  AI_MODEL: {{ .Values.config.ai.model | quote }}
  AI_TIMEOUT_MS: {{ .Values.config.ai.timeoutMs | quote }}
  AI_MAX_RETRIES: {{ .Values.config.ai.maxRetries | quote }}
  AI_TEMPERATURE: {{ .Values.config.ai.temperature | quote }}
