name: Build Multi-Architecture Docker Images

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      version:
        description: "Custom version tag (e.g. beta-1.0.0)"
        required: false
        type: string
      push_latest:
        description: "Also tag as latest"
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: supercheck-io/supercheck

# Explicit permissions following least-privilege principle
# Individual jobs may override with elevated permissions (e.g., packages: write)
permissions:
  contents: read

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      matrix:
        package: [app, worker]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ matrix.package }}/package-lock.json

      - name: Install dependencies
        working-directory: ./${{ matrix.package }}
        run: npm ci --prefer-offline --no-audit

      - name: Type check
        working-directory: ./${{ matrix.package }}
        run: npx tsc --noEmit

      - name: Lint
        working-directory: ./${{ matrix.package }}
        run: |
          if [ "${{ matrix.package }}" = "app" ]; then
            npm run lint -- --max-warnings 0
          else
            echo "Skipping worker lint - fix lint issues and re-enable later"
          fi

      - name: Run tests
        working-directory: ./${{ matrix.package }}
        run: npm run test:cov -- --maxWorkers=2
        env:
          NODE_ENV: test

      - name: Build check
        working-directory: ./${{ matrix.package }}
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: ${{ matrix.package == 'app' && 'true' || 'false' }}

  build-and-push:
    name: Build and Push Docker Images
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          docker system df

          # Remove unnecessary tools and packages to free up space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

          # Clean up Docker system to reclaim space
          docker system prune -af --volumes

          # Clean up npm cache
          npm cache clean --force || true

          # Clean up temp directories
          rm -rf /tmp/* || true
          rm -rf /var/tmp/* || true

          # Clean up GitHub Actions cache
          rm -rf /home/runner/actions-runner/cached/_diag/* || true

          echo "=== After cleanup ==="
          df -h
          docker system df

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU for multi-arch builds
        uses: docker/setup-qemu-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.PAT_TOKEN }}

      - name: Check registry access
        run: |
          echo "Testing registry access..."
          echo "Registry: ${{ env.REGISTRY }}"
          echo "Username: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Custom Version: ${{ github.event.inputs.version }}"
          echo "Push Latest: ${{ github.event.inputs.push_latest }}"

      - name: Extract app metadata
        id: app-meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/app
          tags: |
            # Full version for releases (e.g. 1.2.3 or 1.2.3-canary.1)
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            # Major.minor for stable releases only (e.g. 1.2)
            type=semver,pattern={{major}}.{{minor}},enable=${{ startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-') }}
            # Custom version from manual workflow input
            type=raw,value=${{ github.event.inputs.version }},enable=${{ github.event.inputs.version != '' }}
            # Latest tag ONLY for stable releases (no prerelease suffix like -canary, -beta, -alpha, -rc)
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-canary') && !contains(github.ref, '-beta') && !contains(github.ref, '-alpha') && !contains(github.ref, '-rc') }}
            # Latest tag override for manual builds (use with caution)
            type=raw,value=latest,enable=${{ github.event.inputs.push_latest == 'true' }}
            # Fallback tag using git SHA for manual builds without custom version
            type=sha,prefix={{branch}}-,suffix=-${{ github.run_number }},enable=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version == '' }}

      - name: Extract worker metadata
        id: worker-meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/worker
          tags: |
            # Full version for releases (e.g. 1.2.3 or 1.2.3-canary.1)
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            # Major.minor for stable releases only (e.g. 1.2)
            type=semver,pattern={{major}}.{{minor}},enable=${{ startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-') }}
            # Custom version from manual workflow input
            type=raw,value=${{ github.event.inputs.version }},enable=${{ github.event.inputs.version != '' }}
            # Latest tag ONLY for stable releases (no prerelease suffix like -canary, -beta, -alpha, -rc)
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-canary') && !contains(github.ref, '-beta') && !contains(github.ref, '-alpha') && !contains(github.ref, '-rc') }}
            # Latest tag override for manual builds (use with caution)
            type=raw,value=latest,enable=${{ github.event.inputs.push_latest == 'true' }}
            # Fallback tag using git SHA for manual builds without custom version
            type=sha,prefix={{branch}}-,suffix=-${{ github.run_number }},enable=${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version == '' }}

      - name: Build and push app image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          file: ./app/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.app-meta.outputs.tags }}
          labels: ${{ steps.app-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Clean up after app build
        run: |
          echo "=== Cleaning up after app build ==="
          docker system prune -af
          df -h

      - name: Build and push worker image
        uses: docker/build-push-action@v5
        with:
          context: ./worker
          file: ./worker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.worker-meta.outputs.tags }}
          labels: ${{ steps.worker-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image names
        run: |
          echo "App image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/app"
          echo "Worker image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/worker"
          echo "App tags:"
          echo "${{ steps.app-meta.outputs.tags }}"
          echo "Worker tags:"
          echo "${{ steps.worker-meta.outputs.tags }}"

  e2e-tests:
    name: E2E Tests
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: true # Don't fail workflow on test failures

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-e2e-${{ hashFiles('app/e2e/package-lock.json') }}
          restore-keys: npm-e2e-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('app/e2e/package-lock.json') }}
          restore-keys: playwright-

      - name: Install dependencies
        working-directory: ./app/e2e
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./app/e2e
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        id: e2e-tests
        working-directory: ./app/e2e
        run: npx playwright test --grep "@smoke|@critical" --reporter=html,json,github
        timeout-minutes: 20
        continue-on-error: true
        env:
          CI: true
          E2E_BASE_URL: ${{ secrets.E2E_BASE_URL }}
          E2E_TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}
          E2E_TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}

      - name: Generate report on timeout
        if: always()
        working-directory: ./app/e2e
        run: |
          # Ensure report directory exists even if tests timed out
          mkdir -p playwright-report
          if [ ! -f playwright-report/index.html ]; then
            echo "<html><body><h1>Tests timed out</h1><p>The E2E tests did not complete within the timeout. Check the workflow logs.</p></body></html>" > playwright-report/index.html
          fi

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: app/e2e/playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: app/e2e/test-results/
          retention-days: 7

      - name: Create test summary
        if: always()
        run: |
          echo "## ðŸŽ­ E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "app/e2e/test-results/results.json" ]; then
            # Parse JSON results and create summary
            PASSED=$(jq '.stats.expected // 0' app/e2e/test-results/results.json)
            FAILED=$(jq '.stats.unexpected // 0' app/e2e/test-results/results.json)
            SKIPPED=$(jq '.stats.skipped // 0' app/e2e/test-results/results.json)
            DURATION=$(jq '.stats.duration // 0' app/e2e/test-results/results.json)
            
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Duration | ${DURATION}ms |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.e2e-tests.outcome }}" == "failure" ]; then
              echo "> âš ï¸ **Some tests failed.** Download the playwright-report artifact and open index.html." >> $GITHUB_STEP_SUMMARY
            else
              echo "> âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No test results found. Tests may have failed to start." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for more details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** E2E test failures do not block the release. Download the **playwright-report** artifact for the full HTML report." >> $GITHUB_STEP_SUMMARY
